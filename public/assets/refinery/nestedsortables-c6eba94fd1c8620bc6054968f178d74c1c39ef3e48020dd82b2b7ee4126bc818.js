!function(f){f.widget("mjs.nestedSortable",f.extend({},f.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",doNotClear:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,isAllowed:function(){return!0}},_create:function(){if(this.element.data("sortable",this.element.data("nestedSortable")),!this.element.is(this.options.listType))throw new Error("nestedSortable: Please check the listType option is set to your actual list type");return f.ui.sortable.prototype._create.apply(this,arguments)},destroy:function(){return this.element.removeData("nestedSortable").unbind(".nestedSortable"),f.ui.sortable.prototype.destroy.apply(this,arguments)},_mouseDrag:function(t){this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs);var e=this.options;if(this.options.scroll){var i=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<e.scrollSensitivity?this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop+e.scrollSpeed:t.pageY-this.overflowOffset.top<e.scrollSensitivity&&(this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop-e.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<e.scrollSensitivity?this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft+e.scrollSpeed:t.pageX-this.overflowOffset.left<e.scrollSensitivity&&(this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft-e.scrollSpeed)):(t.pageY-f(document).scrollTop()<e.scrollSensitivity?i=f(document).scrollTop(f(document).scrollTop()-e.scrollSpeed):f(window).height()-(t.pageY-f(document).scrollTop())<e.scrollSensitivity&&(i=f(document).scrollTop(f(document).scrollTop()+e.scrollSpeed)),t.pageX-f(document).scrollLeft()<e.scrollSensitivity?i=f(document).scrollLeft(f(document).scrollLeft()-e.scrollSpeed):f(window).width()-(t.pageX-f(document).scrollLeft())<e.scrollSensitivity&&(i=f(document).scrollLeft(f(document).scrollLeft()+e.scrollSpeed))),!1!==i&&f.ui.ddmanager&&!e.dropBehaviour&&f.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute");var s=this.placeholder.offset().top;this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var o=this.items.length-1;0<=o;o--){var r=this.items[o],l=r.item[0],n=this._intersectsWithPointer(r);if(n&&!(l==this.currentItem[0]||this.placeholder[1==n?"next":"prev"]()[0]==l||f.contains(this.placeholder[0],l)||"semi-dynamic"==this.options.type&&f.contains(this.element[0],l))){if(f(l).mouseenter(),this.direction=1==n?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(r))break;f(l).mouseleave(),this._rearrange(t,r),this._clearEmpty(l),this._trigger("change",t,this._uiHash());break}}var h=this.placeholder[0].parentNode.parentNode&&f(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?f(this.placeholder[0].parentNode.parentNode):null,a=this._getLevel(this.placeholder),p=this._getChildLevels(this.helper),c=this.placeholder[0].previousSibling?f(this.placeholder[0].previousSibling):null;if(null!=c)for(;"li"!=c[0].nodeName.toLowerCase()||c[0]==this.currentItem[0]||c[0]==this.helper[0];){if(!c[0].previousSibling){c=null;break}c=f(c[0].previousSibling)}var d=this.placeholder[0].nextSibling?f(this.placeholder[0].nextSibling):null;if(null!=d)for(;"li"!=d[0].nodeName.toLowerCase()||d[0]==this.currentItem[0]||d[0]==this.helper[0];){if(!d[0].nextSibling){d=null;break}d=f(d[0].nextSibling)}var u=document.createElement(e.listType);return this.beyondMaxLevels=0,null!=h&&null==d&&(e.rtl&&this.positionAbs.left+this.helper.outerWidth()>h.offset().left+h.outerWidth()||!e.rtl&&this.positionAbs.left<h.offset().left)?(h.after(this.placeholder[0]),this._clearEmpty(h[0]),this._trigger("change",t,this._uiHash())):null!=c&&(e.rtl&&this.positionAbs.left+this.helper.outerWidth()<c.offset().left+c.outerWidth()-e.tabSize||!e.rtl&&this.positionAbs.left>c.offset().left+e.tabSize)?(this._isAllowed(c,a,a+p+1),c.children(e.listType).length||c[0].appendChild(u),s&&s<=c.offset().top?c.children(e.listType).prepend(this.placeholder):c.children(e.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",t,this._uiHash())):this._isAllowed(h,a,a+p),this._contactContainers(t),f.ui.ddmanager&&f.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,e){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?f(this.domPosition.prev).after(this.placeholder):f(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",t,this._uiHash()));for(var i=this.items.length-1;0<=i;i--){var s=this.items[i].item[0];this._clearEmpty(s)}f.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(t){var i=f.extend({},this.options,t),e=this._getItemsAsjQuery(i&&i.connected),s=[];return f(e).each(function(){var t=(f(i.item||this).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/),e=(f(i.item||this).parent(i.listType).parent(i.items).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/);t&&s.push((i.key||t[1])+"["+(i.key&&i.expression?t[1]:t[2])+"]="+(e?i.key&&i.expression?e[1]:e[2]:i.rootID))}),!s.length&&i.key&&s.push(i.key+"="),s.join("&")},toHierarchy:function(t){function s(t){var e=(f(t).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);if(e){var i={id:e[2]};return 0<f(t).children(o.listType).children(o.items).length&&(i.children=[],f(t).children(o.listType).children(o.items).each(function(){var t=s(this);i.children.push(t)})),i}}var o=f.extend({},this.options,t),e=(o.startDepthCount,[]);return f(this.element).children(o.items).each(function(){var t=s(this);e.push(t)}),e},toArray:function(t){function l(t,e,i){var s,o,r=i+1;(0<f(t).children(n.listType).children(n.items).length&&(e++,f(t).children(n.listType).children(n.items).each(function(){r=l(f(this),e,r)}),e--),s=f(t).attr(n.attribute||"id").match(n.expression||/(.+)[-=_](.+)/),e===h+1)?o=n.rootID:o=f(t).parent(n.listType).parent(n.items).attr(n.attribute||"id").match(n.expression||/(.+)[-=_](.+)/)[2];return s&&a.push({item_id:s[2],parent_id:o,depth:e,left:i,right:r}),i=r+1}var n=f.extend({},this.options,t),h=n.startDepthCount||0,a=[],e=2;return a.push({item_id:n.rootID,parent_id:"none",depth:h,left:"1",right:2*(f(n.items,this.element).length+1)}),f(this.element).children(n.items).each(function(){e=l(this,h+1,e)}),a=a.sort(function(t,e){return t.left-e.left})},_clearEmpty:function(t){var e=f(t).children(this.options.listType);!e.length||e.children().length||this.options.doNotClear||e.remove()},_getLevel:function(t){var e=1;if(this.options.listType)for(var i=t.closest(this.options.listType);i&&0<i.length&&!i.is(".ui-sortable");)e++,i=i.parent().closest(this.options.listType);return e},_getChildLevels:function(t,i){var s=this,e=this.options,o=0;return i=i||0,f(t).children(e.listType).children(e.items).each(function(t,e){o=Math.max(s._getChildLevels(e,i+1),o)}),i?o+1:o},_isAllowed:function(t,e,i){var s=this.options,o=!!f(this.domPosition.parent).hasClass("ui-sortable"),r=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");!s.isAllowed(this.currentItem,t)||t&&t.hasClass(s.disableNesting)||s.protectRoot&&(null==t&&!o||o&&1<e)?(this.placeholder.addClass(s.errorClass),this.beyondMaxLevels=r<i&&0!=r?i-r:1):r<i&&0!=r?(this.placeholder.addClass(s.errorClass),this.beyondMaxLevels=i-r):(this.placeholder.removeClass(s.errorClass),this.beyondMaxLevels=0)}})),f.mjs.nestedSortable.prototype.options=f.extend({},f.ui.sortable.prototype.options,f.mjs.nestedSortable.prototype.options)}(jQuery);